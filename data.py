from typing import List, Union

import json
import tqdm
import torch

DEVICE = "cuda" if torch.cuda.is_available() else "cpu"


def load_drawings(file_path: str, sparsity: int = 1) -> List[List[int]]:
    drawings = []

    with open(file_path, "r") as file:
        lines = file.readlines()

        for line in tqdm.tqdm(lines[::sparsity], desc="Loading data"):
            entry = json.loads(line)
            if not entry["recognized"]:
                continue
                
            drawing = [[0, 0, 0, 1, 0]]  # start with pen lifted
            for _stroke_index, (stroke_xs, stroke_ys) in enumerate(entry["drawing"]):
                positions = list(zip(stroke_xs, stroke_ys))

                # do normal movement
                for x, y in positions:
                    drawing.append([
                        x / 255,
                        y / 255,
                        1, 0, 0
                    ])

                # modify end stroke
                drawing[-1][2] = 0
                drawing[-1][3] = 1
                drawing[-1][4] = 0

            # end drawing
            drawing.append([0, 0, 0, 0, 1])
            drawings.append(drawing)

    return drawings


def pad_drawings(drawings: List[List[int]], max_sequence_length: int) -> List[List[int]]:
    for index in tqdm.tqdm(range(len(drawings)), desc="Padding data"):
        sequence_length = len(drawings[index])
        num_samples_to_add = max_sequence_length - sequence_length

        if num_samples_to_add > 0:
            drawings[index].extend([[0, 0, 0, 0, 1]] * num_samples_to_add)

        if num_samples_to_add < 0:
            drawings[index] = drawings[index][:max_sequence_length]

        assert len(drawings[index]) == max_sequence_length

    return drawings


class DrawingsDataset(torch.utils.data.Dataset):
    def __init__(self, drawings, scale_factor: Union[float, None] = 0.2):
        self.drawings = drawings
        self.scale_factor = scale_factor


    def _get_random_scale_factor(self) -> float:
        return (  # lerp
            torch.rand(1)[0] * ((1 + self.scale_factor) - (1 - self.scale_factor))
            + (1 - self.scale_factor)
        )


    def __len__(self) -> int:
        return len(self.drawings)


    def __getitem__(self, index: int) -> torch.Tensor:
        drawing = self.drawings[index]

        if self.scale_factor is not None:
            drawing[:, 0] *= self._get_random_scale_factor()
            drawing[:, 1] *= self._get_random_scale_factor()

        return drawing


def get_toy_drawings(num_repeats: int = 1) -> torch.Tensor:
    return torch.tensor([[
        [0.0000, 0.0000, 0.0000, 1.0000, 0.0000],
        [0.5725, 0.9608, 1.0000, 0.0000, 0.0000],
        [0.4431, 0.9961, 1.0000, 0.0000, 0.0000],
        [0.3569, 1.0000, 1.0000, 0.0000, 0.0000],
        [0.2745, 0.9882, 1.0000, 0.0000, 0.0000],
        [0.1922, 0.9490, 1.0000, 0.0000, 0.0000],
        [0.1255, 0.8824, 1.0000, 0.0000, 0.0000],
        [0.0588, 0.7804, 1.0000, 0.0000, 0.0000],
        [0.0078, 0.6157, 1.0000, 0.0000, 0.0000],
        [0.0039, 0.5098, 1.0000, 0.0000, 0.0000],
        [0.0118, 0.4510, 1.0000, 0.0000, 0.0000],
        [0.0627, 0.3373, 1.0000, 0.0000, 0.0000],
        [0.1294, 0.2431, 1.0000, 0.0000, 0.0000],
        [0.1804, 0.1961, 1.0000, 0.0000, 0.0000],
        [0.3373, 0.1098, 1.0000, 0.0000, 0.0000],
        [0.6824, 0.0000, 1.0000, 0.0000, 0.0000],
        [0.6784, 0.0196, 1.0000, 0.0000, 0.0000],
        [0.6549, 0.0353, 1.0000, 0.0000, 0.0000],
        [0.4353, 0.1608, 1.0000, 0.0000, 0.0000],
        [0.2941, 0.2863, 1.0000, 0.0000, 0.0000],
        [0.2471, 0.3529, 1.0000, 0.0000, 0.0000],
        [0.2235, 0.4118, 1.0000, 0.0000, 0.0000],
        [0.2353, 0.4941, 1.0000, 0.0000, 0.0000],
        [0.3373, 0.6667, 1.0000, 0.0000, 0.0000],
        [0.4000, 0.7294, 1.0000, 0.0000, 0.0000],
        [0.4745, 0.7608, 1.0000, 0.0000, 0.0000],
        [0.5529, 0.7647, 1.0000, 0.0000, 0.0000],
        [0.8275, 0.7294, 1.0000, 0.0000, 0.0000],
        [0.9255, 0.7059, 1.0000, 0.0000, 0.0000],
        [0.8314, 0.7529, 1.0000, 0.0000, 0.0000],
        [0.5961, 0.9176, 1.0000, 0.0000, 0.0000],
        [0.5373, 0.9451, 1.0000, 0.0000, 0.0000],
        [0.4902, 0.9490, 0.0000, 1.0000, 0.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0000]
    ]], dtype=torch.float32, device=DEVICE).repeat(num_repeats, 1, 1)


def get_toy_drawings_trivial(num_repeats: int = 1) -> torch.Tensor:
    return torch.tensor([[
        [0.4353, 0.1608, 1.0000, 0.0000, 0.0000],
        [0.4353, 0.1608, 1.0000, 0.0000, 0.0000],
        [0.4353, 0.1608, 1.0000, 0.0000, 0.0000],
        [0.4353, 0.1608, 1.0000, 0.0000, 0.0000],
        [0.4353, 0.1608, 1.0000, 0.0000, 0.0000],
        [0.4353, 0.1608, 1.0000, 0.0000, 0.0000],
        [0.4353, 0.1608, 1.0000, 0.0000, 0.0000],
        [0.4353, 0.1608, 1.0000, 0.0000, 0.0000],
        [0.4353, 0.1608, 1.0000, 0.0000, 0.0000],
        [0.4353, 0.1608, 1.0000, 0.0000, 0.0000],
        [0.4353, 0.1608, 1.0000, 0.0000, 0.0000],
        [0.4353, 0.1608, 1.0000, 0.0000, 0.0000],
        [0.4353, 0.1608, 1.0000, 0.0000, 0.0000],
        [0.4353, 0.1608, 1.0000, 0.0000, 0.0000],
        [0.4353, 0.1608, 1.0000, 0.0000, 0.0000],
        [0.4353, 0.1608, 1.0000, 0.0000, 0.0000],
        [0.4353, 0.1608, 1.0000, 0.0000, 0.0000],
        [0.4353, 0.1608, 1.0000, 0.0000, 0.0000],
        [0.4353, 0.1608, 1.0000, 0.0000, 0.0000],
        [0.4353, 0.1608, 1.0000, 0.0000, 0.0000],
        [0.4353, 0.1608, 1.0000, 0.0000, 0.0000],
        [0.4353, 0.1608, 1.0000, 0.0000, 0.0000],
        [0.4353, 0.1608, 1.0000, 0.0000, 0.0000],
        [0.4353, 0.1608, 1.0000, 0.0000, 0.0000],
    ]], dtype=torch.float32, device=DEVICE).repeat(num_repeats, 1, 1)
